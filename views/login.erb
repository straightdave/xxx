<div class="container">
  <div class="row">
    <div class="col-md-4 col-md-offset-4">
      <p>
        <div class="form-group has-feedback">
          <input class="form-control" type="text" name="login_name" id="u"
                 value="<%= URI.decode(params['u']) if params['u'] %>" placeholder="登录名" />
          <span class="form-control-feedback fui-user"></span>
        </div>
      </p>
      <p>
        <div class="form-group has-feedback">
          <input class="form-control" type="password" name="password" id="p" placeholder="密码" />
          <span class="form-control-feedback fui-lock"></span>
        </div>
      </p>
      <p>
        <div class="form-group">
          <label>
            <input type="checkbox" name="rememberme" id="r2" /> &nbsp;
            记住我
          </label>
        </div>
      </p>
      <div id="err-msg2" class="text-danger"></div>
      <button class="btn btn-primary btn-lg" onclick="javascript:login2();">登录</a>
    </div>
  </div>
</div>
<script>
  function GetUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)","i");
    var r = window.location.search.substr(1).match(reg);
    if (r!=null) return (r[2]); return null;
  }
  function login2() {
    var is_valid = true;
    var name_input = $("input[id='u']");
    var name = name_input.val().trim();
    var reg=/^[0-9a-zA-Z_]{1,50}$/i;
    if (name == "" || !reg.test(name)) {
      set_error(name_input, "登录名非法");
      $("#err-msg2").text("登录名为下划线、字母和数字的组合，不超过50个字符");
      is_valid = false;
    }
    else {
      set_ok(name_input);
    }
    var pass_input = $("input[id='p']");
    var pass = pass_input.val().trim();
    if (pass == "") {
      set_error(pass_input, "请填写密码");
      is_valid = false;
    }
    else {
      set_ok(pass_input);
    }
    var remember = $("input[id='r2']").prop("checked");
    if (is_valid) {
      var data = {
        "login_name" : name,
        "password" : pass,
        "rememberme" : remember
      };
      $.post("/login", data, function (data, status) {
        if(data.ret == "error"){
          $("#err-msg2").text("登录名或密码错误");
        } else if(data.ret == "success") {
          var return_url = GetUrlParam("returnurl") || "/";
          location.replace(return_url);
        }
      });
    }
  }
</script>
